<!DOCTYPE html>
<html lang="id">
<head>
    
    <title>Stok Opname</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.4.8/sweetalert2.min.css">
    <style>
    /* Palette dan Variables */
:root {
    --primary-color: #4a6cf7;
    --secondary-color: #2ecc71;
    --danger-color: #e74c3c;
    --warning-color: #f39c12;
    --light-color: #f5f5f5;
    --dark-color: #333;
    --border-color: #ddd;
    --bg-color: #f0f2f5;
    --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    --header-bg: #f8f9fa;
}

/* Base Styles */
* {
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    margin: 0;
    padding: 0;
    background-color: var(--bg-color);
    color: #333;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.card {
    background-color: white;
    border-radius: 10px;
    box-shadow: var(--card-shadow);
    padding: 20px;
    margin-bottom: 20px;
}

/* Header dan Judul */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

h1, h2, h3 {
    color: var(--dark-color);
    margin: 0;
    font-weight: 600;
}

h1 {
    font-size: 24px;
}

h2 {
    font-size: 20px;
    margin-bottom: 15px;
}

h3 {
    font-size: 18px;
}

/* Form dan Filter */
.filter-section {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
    background-color: var(--header-bg);
    padding: 15px;
    border-radius: 8px;
}

.form-group {
    flex: 1;
    min-width: 200px;
}

label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #555;
    font-size: 14px;
}

select, input {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    background-color: #fff;
    transition: border 0.3s;
}

select:focus, input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(74, 108, 247, 0.1);
}

/* Buttons */
button {
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-secondary {
    background-color: var(--secondary-color);
    color: white;
}

.btn-danger {
    background-color: var(--danger-color);
    color: white;
}

.btn-warning {
    background-color: var(--warning-color);
    color: white;
}

button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

button:active {
    transform: translateY(0);
}

/* Tables */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 14px;
}

th, td {
    border: 1px solid var(--border-color);
    padding: 12px;
    text-align: left;
}

th {
    background-color: var(--header-bg);
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
}

tr:nth-child(even) {
    background-color: #f9f9f9;
}

tr:hover {
    background-color: #f0f7ff;
}

.category-header {
    background-color: #e0f0ff;
    font-size: 16px;
    padding: 10px;
    color: #333;
}

/* Status Styles */
.status-pending {
    color: var(--warning-color);
    font-weight: 600;
}

.status-completed {
    color: var(--secondary-color);
    font-weight: 600;
}

.status-adjusted {
    color: var(--primary-color);
    font-weight: 600;
}

.selisih-positif {
    color: var(--secondary-color);
    font-weight: 600;
}

.selisih-negatif {
    color: var(--danger-color);
    font-weight: 600;
}

.selisih-nol {
    color: var(--dark-color);
}

/* Search Box */
.search-box {
    position: relative;
    margin-bottom: 20px;
}

.search-box input {
    padding-left: 35px;
    border-radius: 50px;
    transition: all 0.3s;
}

.search-box input:focus {
    box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
}

.search-box i {
    position: absolute;
    left: 12px;
    top: 12px;
    color: #888;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 8px;
}

.action-btn {
    padding: 6px 12px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 5px;
    border-radius: 4px;
}

/* Summary Dashboard */
.summary-box {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.summary-item {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    border-left: 4px solid var(--primary-color);
    transition: transform 0.3s;
}

.summary-item:nth-child(2) {
    border-left-color: var(--secondary-color);
}

.summary-item:nth-child(3) {
    border-left-color: var(--warning-color);
}

.summary-item:nth-child(4) {
    border-left-color: var(--danger-color);
}

.summary-item:hover {
    transform: translateY(-2px);
}

.summary-title {
    font-size: 14px;
    color: #666;
    margin-bottom: 5px;
}

.summary-value {
    font-size: 20px;
    font-weight: 600;
    color: #333;
}

/* Badges */
.badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
}

.badge-danger {
    background-color: #ffecec;
    color: var(--danger-color);
}

.badge-success {
    background-color: #ecffef;
    color: var(--secondary-color);
}

.badge-warning {
    background-color: #fff8ec;
    color: var(--warning-color);
}

/* Opname Header */
.stockopname-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.stockopname-header p {
    color: #666;
    margin: 5px 0 0 0;
}

/* Input dalam tabel */
.input-aktual {
    width: 100px;
    text-align: center;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 6px;
}

.input-aktual:focus {
    border-color: var(--primary-color);
    outline: none;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    overflow: auto;
}

.modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 25px;
    border-radius: 10px;
    max-width: 600px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    position: relative;
    animation: modalFadeIn 0.3s;
}

@keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.close {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 24px;
    cursor: pointer;
    color: #999;
    transition: color 0.3s;
}

.close:hover {
    color: #333;
}

.modal-title {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 20px;
    color: #333;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 25px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
}

/* Loading Spinner */
.loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

.spinner {
    border: 4px solid rgba(74, 108, 247, 0.1);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsif pada ukuran layar kecil */
@media (max-width: 768px) {
    .filter-section {
        flex-direction: column;
    }
    
    .form-group {
        width: 100%;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .summary-box {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        width: 90%;
        margin: 10% auto;
    }

    th, td {
        padding: 8px;
        font-size: 13px;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-clipboard-check"></i> Stok Opname</h1>
            <div>
                <button id="createOpnameBtn" class="btn-primary">
                    <i class="fas fa-plus"></i> Buat Stok Opname Baru
                </button>
            </div>
        </div>
        
        <!-- Ringkasan Stok Opname -->
        <div class="card">
            <h2>Ringkasan Stok Opname</h2>
            <div class="summary-box">
                <div class="summary-item">
                    <div class="summary-title">Total Stok Opname</div>
                    <div class="summary-value" id="totalOpname">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-title">Stok Opname Hari Ini</div>
                    <div class="summary-value" id="todayOpname">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-title">Selisih Stok (Total)</div>
                    <div class="summary-value" id="totalSelisihStok">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-title">Selisih Rupiah (Total)</div>
                    <div class="summary-value" id="totalSelisihRupiah">Rp 0</div>
                </div>
            </div>
            
            <!-- Filter Riwayat Stok Opname -->
            <div class="filter-section">
                <div class="form-group">
                    <label for="filterTanggal">Filter Tanggal</label>
                    <input type="date" id="filterTanggal">
                </div>
                <div class="form-group">
                    <label for="filterStatus">Status</label>
                    <select id="filterStatus">
                        <option value="all">Semua</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Selesai</option>
                        <option value="adjusted">Disesuaikan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterKategori">Kategori</label>
                    <select id="filterKategori">
                        <option value="all">Semua</option>
                        <!-- Kategori akan diisi dari JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button id="filterBtn" class="btn-primary">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                </div>
            </div>
            
            <!-- Tabel Riwayat Stok Opname -->
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchOpname" placeholder="Cari stok opname...">
            </div>
            <table id="tabelRiwayatOpname">
                <thead>
                    <tr>
                        <th>No. Opname</th>
                        <th>Tanggal</th>
                        <th>Kategori</th>
                        <th>Jumlah Item</th>
                        <th>Petugas</th>
                        <th>Status</th>
                        <th>Selisih Stok</th>
                        <th>Selisih Rupiah</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data riwayat stok opname akan diisi dari JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Detail Stok Opname (muncul saat ada stok opname aktif) -->
        <div id="detailOpnameContainer" class="card" style="display: none;">
            <div class="stockopname-header">
                <div>
                    <h2>Detail Stok Opname</h2>
                    <p>No. Opname: <span id="opnameNumber"></span> | Tanggal: <span id="opnameDate"></span> | Status: <span id="opnameStatus"></span></p>
                </div>
                <div class="action-buttons">
                    <button id="saveOpnameBtn" class="btn-primary">
                        <i class="fas fa-save"></i> Simpan
                    </button>
                    <button id="completeOpnameBtn" class="btn-secondary">
                        <i class="fas fa-check-circle"></i> Selesaikan
                    </button>
                    <button id="cancelOpnameBtn" class="btn-danger">
                        <i class="fas fa-times-circle"></i> Batal
                    </button>
                </div>
            </div>
            
            <!-- Filter Stok Opname -->
            <div class="filter-section">
                <div class="form-group">
                    <label for="opnameFilterKategori">Kategori</label>
                    <select id="opnameFilterKategori">
                        <option value="all">Semua</option>
                        <!-- Kategori akan diisi dari JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="opnameFilterBarang">Cari Barang</label>
                    <input type="text" id="opnameFilterBarang" placeholder="Kode/Nama barang...">
                </div>
                <div class="form-group">
                    <label for="opnameFilterSelisih">Filter Selisih</label>
                    <select id="opnameFilterSelisih">
                        <option value="all">Semua</option>
                        <option value="plus">Selisih Positif</option>
                        <option value="minus">Selisih Negatif</option>
                        <option value="zero">Tidak Ada Selisih</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button id="opnameFilterBtn" class="btn-primary">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                </div>
            </div>
            
            <!-- Tabel Detail Stok Opname -->
            <table id="tabelDetailOpname">
                <thead>
                    <tr>
                        <th>Kategori</th>
                        <th>Kode Toko</th>
                        <th>Kode Barang</th>
                        <th>PLU</th>
                        <th>Nama Barang</th>
                        <th>Stok Sistem</th>
                        <th>Stok Aktual</th>
                        <th>Selisih</th>
                        <th>Harga Beli</th>
                        <th>Selisih Rupiah</th>
                        <th>Keterangan</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data detail stok opname akan diisi dari JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal Pembuatan Stok Opname Baru -->
    <div id="createOpnameModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeCreateModal">&times;</span>
            <h3 class="modal-title">Buat Stok Opname Baru</h3>
            <div class="form-group">
                <label for="opnameType">Tipe Stok Opname</label>
                <select id="opnameType">
                    <option value="all">Semua Barang</option>
                    <option value="category">Per Kategori</option>
                    <option value="selected">Barang Tertentu</option>
                </select>
            </div>
            
            <!-- Form untuk opname per kategori -->
            <div id="categoryForm" class="form-group" style="display: none;">
                <label for="selectCategory">Pilih Kategori</label>
                <select id="selectCategory">
                    <!-- Kategori akan diisi dari JavaScript -->
                </select>
            </div>
            
            <!-- Form untuk opname barang tertentu -->
            <div id="selectedItemsForm" style="display: none;">
                <div class="form-group">
                    <label for="searchItems">Cari Barang</label>
                    <input type="text" id="searchItems" placeholder="Kode/Nama barang...">
                </div>
                <table id="itemSelectionTable">
                    <thead>
                        <tr>
                            <th>Pilih</th>
                            <th>Kode</th>
                            <th>Nama</th>
                            <th>Kategori</th>
                            <th>Stok</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data barang akan diisi dari JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="form-group">
                <label for="opnameNote">Catatan (Opsional)</label>
                <input type="text" id="opnameNote" placeholder="Catatan stok opname...">
            </div>
            
            <div class="modal-footer">
                <button id="startOpnameBtn" class="btn-primary">Mulai Stok Opname</button>
                <button id="cancelCreateBtn" class="btn-danger">Batal</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Detail Riwayat Stok Opname -->
    <div id="historyDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeHistoryModal">&times;</span>
            <h3 class="modal-title">Detail Riwayat Stok Opname</h3>
            <p>No. Opname: <span id="historyOpnameNumber"></span> | Tanggal: <span id="historyOpnameDate"></span></p>
            <p>Status: <span id="historyOpnameStatus"></span> | Petugas: <span id="historyOpnameStaff"></span></p>
            
            <table id="historyDetailTable">
                <thead>
                    <tr>
                        <th>Kategori</th>
                        <th>Kode Barang</th>
                        <th>Nama Barang</th>
                        <th>Stok Sistem</th>
                        <th>Stok Aktual</th>
                        <th>Selisih</th>
                        <th>Selisih Rupiah</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data detail riwayat akan diisi dari JavaScript -->
                </tbody>
            </table>
            
            <div class="modal-footer">
                <button id="closeHistoryDetailBtn" class="btn-primary">Tutup</button>
                <button id="adjustStockBtn" class="btn-warning" style="display: none;">Adjust Stok</button>
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loadingOverlay" class="loading" style="display: none;">
        <div class="spinner"></div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.4.8/sweetalert2.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Global variables
            let currentOpname = null;
            let allBarang = [];
            let filteredBarang = [];
            let riwayatOpname = [];
            let activeOpnameItems = [];
            
            // Load data from localStorage
            function loadData() {
                allBarang = JSON.parse(localStorage.getItem('barang')) || [];
                riwayatOpname = JSON.parse(localStorage.getItem('stokOpname')) || [];
                updateSummary();
                loadRiwayatOpname();
                loadKategoriOptions();
            }
            
            // Format currency to Rupiah
            function formatRupiah(angka) {
                return 'Rp ' + parseFloat(angka).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }
            
            // Update summary statistics
            function updateSummary() {
                const totalOpname = riwayatOpname.length;
                
                // Count today's opname
                const today = new Date().toISOString().split('T')[0];
                const todayOpname = riwayatOpname.filter(op => op.tanggal.split('T')[0] === today).length;
                
                // Calculate total discrepancies
                let totalSelisihStok = 0;
                let totalSelisihRupiah = 0;
                
                riwayatOpname.forEach(opname => {
                    if (opname.status === 'completed' || opname.status === 'adjusted') {
                        opname.items.forEach(item => {
                            const selisih = item.stokAktual - item.stokSistem;
                            totalSelisihStok += selisih;
                            totalSelisihRupiah += selisih * item.hargaBeli;
                        });
                    }
                });
                
                document.getElementById('totalOpname').textContent = totalOpname;
                document.getElementById('todayOpname').textContent = todayOpname;
                document.getElementById('totalSelisihStok').textContent = totalSelisihStok;
                document.getElementById('totalSelisihRupiah').textContent = formatRupiah(totalSelisihRupiah);
            }
            
            // Load categories into select options
            function loadKategoriOptions() {
                const categories = ['A1', 'A2', 'A3', 'A4', 'A5', 'B1', 'B2', 'B3', 'B4', 'B5', 'B6', 'C1', 'C2', 'C3', 'C4', 'C5', 'C6', 'C7', 'Uncategorized'];
                
                // Add options to filter dropdowns
                const filterKategori = document.getElementById('filterKategori');
                const opnameFilterKategori = document.getElementById('opnameFilterKategori');
                const selectCategory = document.getElementById('selectCategory');
                
                // Clear existing options
                filterKategori.innerHTML = '<option value="all">Semua</option>';
                opnameFilterKategori.innerHTML = '<option value="all">Semua</option>';
                selectCategory.innerHTML = '';
                
                // Add new options
                categories.forEach(category => {
                    // Only add categories that have items
                    const hasItems = allBarang.some(item => (item.kategori || 'Uncategorized') === category);
                    
                    if (hasItems) {
                        filterKategori.innerHTML += `<option value="${category}">${category}</option>`;
                        opnameFilterKategori.innerHTML += `<option value="${category}">${category}</option>`;
                        selectCategory.innerHTML += `<option value="${category}">${category}</option>`;
                    }
                });
            }
            
            // Load history of stock opname
            function loadRiwayatOpname() {
                const tbody = document.querySelector('#tabelRiwayatOpname tbody');
                tbody.innerHTML = '';
                
                // Apply filters
                const filterTanggal = document.getElementById('filterTanggal').value;
                const filterStatus = document.getElementById('filterStatus').value;
                const filterKategori = document.getElementById('filterKategori').value;
                const searchTerm = document.getElementById('searchOpname').value.toLowerCase();
                
                let filteredOpname = [...riwayatOpname];
                
                // Apply date filter
                if (filterTanggal) {
                    filteredOpname = filteredOpname.filter(op => op.tanggal.split('T')[0] === filterTanggal);
                }
                
                // Apply status filter
                if (filterStatus !== 'all') {
                    filteredOpname = filteredOpname.filter(op => op.status === filterStatus);
                }
                
                // Apply category filter
                if (filterKategori !== 'all') {
                    filteredOpname = filteredOpname.filter(op => {
                        if (op.tipeOpname === 'category') {
                            return op.kategori === filterKategori;
                        } else if (op.tipeOpname === 'selected') {
                            return op.items.some(item => (item.kategori || 'Uncategorized') === filterKategori);
                        }
                        return true; // For 'all' type opname
                    });
                }
                
                // Apply search filter
                if (searchTerm) {
                    filteredOpname = filteredOpname.filter(op => 
                        op.noOpname.toLowerCase().includes(searchTerm) || 
                        op.petugas.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Sort by date, newest first
                filteredOpname.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
                
                // Populate table
                filteredOpname.forEach(opname => {
                    const row = tbody.insertRow();
                    
                    // Calculate totals
                    let totalSelisihStok = 0;
                    let totalSelisihRupiah = 0;
                    
                    if (opname.status === 'completed' || opname.status === 'adjusted') {
                        opname.items.forEach(item => {
                            const selisih = item.stokAktual - item.stokSistem;
                            totalSelisihStok += selisih;
                            totalSelisihRupiah += selisih * item.hargaBeli;
                        });
                    }
                    
                    // Format date
                    const opnameDate = new Date(opname.tanggal);
                    const formattedDate = opnameDate.toLocaleDateString('id-ID', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }).replace(',', '');
                    
                    // Get category or 'Semua'
                    let kategoriText = 'Semua';
                    if (opname.tipeOpname === 'category') {
                        kategoriText = opname.kategori;
                    } else if (opname.tipeOpname === 'selected') {
                        kategoriText = 'Tertentu';
                    }
                    
                    // Set status class
                    let statusClass = '';
                    switch (opname.status) {
                        case 'pending':
                            statusClass = 'status-pending';
                            break;
                        case 'completed':
                            statusClass = 'status-completed';
                            break;
                        case 'adjusted':
                            statusClass = 'status-adjusted';
                            break;
                    }
                    
                    // Set status text
                    let statusText = '';
                    switch (opname.status) {
                        case 'pending':
                            statusText = 'Pending';
                            break;
                        case 'completed':
                            statusText = 'Selesai';
                            break;
                        case 'adjusted':
                            statusText = 'Disesuaikan';
                            break;
                    }
                    
                    // Determine selisih class
                    let selisihClass = 'selisih-nol';
                    if (totalSelisihStok > 0) {
                        selisihClass = 'selisih-positif';
                    } else if (totalSelisihStok < 0) {
                        selisihClass = 'selisih-negatif';
                    }
                    
                    // Create and populate cells
                    const cells = [
                        opname.noOpname,
                        formattedDate,
                        kategoriText,
                        opname.items.length,
                        opname.petugas,
                        `<span class="${statusClass}">${statusText}</span>`,
                        `<span class="${selisihClass}">${totalSelisihStok}</span>`,
                        `<span class="${selisihClass}">${formatRupiah(totalSelisihRupiah)}</span>`
                    ];
                    
                    // Insert cells with values
                    cells.forEach(cellValue => {
                        const cell = row.insertCell();
                        cell.innerHTML = cellValue;
                    });
                    
                    // Add action buttons
                    const actionCell = row.insertCell();
                    actionCell.className = 'action-buttons';
                    
                    // View button
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'action-btn btn-primary';
                    viewBtn.innerHTML = '<i class="fas fa-eye"></i> Lihat';
                    viewBtn.onclick = () => showOpnameDetail(opname.noOpname);
                    actionCell.appendChild(viewBtn);
                    
                    
                    
                    
                    
                    // If status is pending, show continue button
                    if (opname.status === 'pending') {
                        const continueBtn = document.createElement('button');
                        continueBtn.className = 'action-btn btn-secondary';
                        continueBtn.innerHTML = '<i class="fas fa-play"></i> Lanjutkan';
                        continueBtn.onclick = () => continueOpname(opname.noOpname);
                        actionCell.appendChild(continueBtn);
                    }
                    
                    // If status is completed, show adjust button
                    if (opname.status === 'completed') {
                        const adjustBtn = document.createElement('button');
                        adjustBtn.className = 'action-btn btn-warning';
                        adjustBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Adjust';
                        adjustBtn.onclick = () => adjustOpname(opname.noOpname);
                        actionCell.appendChild(adjustBtn);
                    }
                    
                    // Delete button for all stock opname
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'action-btn btn-danger';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Hapus';
                    deleteBtn.onclick = () => deleteOpname(opname.noOpname);
                    actionCell.appendChild(deleteBtn);
                });
            }
            
            // Show opname details in modal
            function showOpnameDetail(noOpname) {
                const opname = riwayatOpname.find(op => op.noOpname === noOpname);
                if (!opname) return;
                
                // Fill modal with data
                document.getElementById('historyOpnameNumber').textContent = opname.noOpname;
                
                // Format date
                const opnameDate = new Date(opname.tanggal);
                const formattedDate = opnameDate.toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(',', '');
                
                document.getElementById('historyOpnameDate').textContent = formattedDate;
                
                // Set status with class
                let statusText = '';
                let statusClass = '';
                switch (opname.status) {
                    case 'pending':
                        statusText = 'Pending';
                        statusClass = 'status-pending';
                        break;
                    case 'completed':
                        statusText = 'Selesai';
                        statusClass = 'status-completed';
                        break;
                    case 'adjusted':
                        statusText = 'Disesuaikan';
                        statusClass = 'status-adjusted';
                        break;
                }
                
                document.getElementById('historyOpnameStatus').innerHTML = `<span class="${statusClass}">${statusText}</span>`;
                document.getElementById('historyOpnameStaff').textContent = opname.petugas;
                
                // Populate detail table
                const tbody = document.querySelector('#historyDetailTable tbody');
                tbody.innerHTML = '';
                
                opname.items.forEach(item => {
                    const selisih = item.stokAktual - item.stokSistem;
                    const selisihRupiah = selisih * item.hargaBeli;
                    
                    // Determine selisih class
                    let selisihClass = 'selisih-nol';
                    if (selisih > 0) {
                        selisihClass = 'selisih-positif';
                    } else if (selisih < 0) {
                        selisihClass = 'selisih-negatif';
                    }
                    
                    const row = tbody.insertRow();
                    
                    // Create and populate cells
                    const cells = [
                        item.kategori || 'Uncategorized',
                        item.kode,
                        item.nama,
                        item.stokSistem,
                        item.stokAktual,
                        `<span class="${selisihClass}">${selisih}</span>`,
                        `<span class="${selisihClass}">${formatRupiah(selisihRupiah)}</span>`
                    ];
                    
                    // Insert cells with values
                    cells.forEach(cellValue => {
                        const cell = row.insertCell();
                        cell.innerHTML = cellValue;
                    });
                });
                
                // Show adjust button only for completed opname
                const adjustBtn = document.getElementById('adjustStockBtn');
                if (opname.status === 'completed') {
                    adjustBtn.style.display = 'block';
                    adjustBtn.onclick = () => adjustOpname(opname.noOpname);
                } else {
                    adjustBtn.style.display = 'none';
                }
                
                // Show modal
                document.getElementById('historyDetailModal').style.display = 'block';
            }
            
            // Create new stock opname
            function createOpname() {
                const opnameType = document.getElementById('opnameType').value;
                const note = document.getElementById('opnameNote').value;
                
                // Get current user
                const username = localStorage.getItem('username');
                if (!username) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Anda harus login terlebih dahulu!'
                    });
                    return;
                }
                
                // Generate opname number
                const date = new Date();
                const formattedDate = date.toISOString().split('T')[0].replace(/-/g, '');
                const randomNum = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                const noOpname = `OP${formattedDate}${randomNum}`;
                
                // Prepare items based on opname type
                let items = [];
                let kategori = null;
                
                if (opnameType === 'all') {
                    // Include all items
                    items = allBarang.map(item => ({
                        kode: item.kode,
                        plu: item.plu || '',
                        nama: item.nama,
                        kategori: item.kategori || 'Uncategorized',
                        kodeToko: item.kodeToko || '',
                        stokSistem: item.stok,
                        stokAktual: null,
                        hargaBeli: item.hargaBeli,
                        hargaJual: item.hargaJual,
                        keterangan: ''
                    }));
                } else if (opnameType === 'category') {
                    // Include items from selected category
                    kategori = document.getElementById('selectCategory').value;
                    items = allBarang
                        .filter(item => (item.kategori || 'Uncategorized') === kategori)
                        .map(item => ({
                            kode: item.kode,
                            plu: item.plu || '',
                            nama: item.nama,
                            kategori: item.kategori || 'Uncategorized',
                            kodeToko: item.kodeToko || '',
                            stokSistem: item.stok,
                            stokAktual: null,
                            hargaBeli: item.hargaBeli,
                            hargaJual: item.hargaJual,
                            keterangan: ''
                        }));
                } else if (opnameType === 'selected') {
                    // Include selected items
                    const checkboxes = document.querySelectorAll('#itemSelectionTable input[type="checkbox"]:checked');
                    const selectedCodes = Array.from(checkboxes).map(cb => cb.value);
                    
                    if (selectedCodes.length === 0) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Peringatan',
                            text: 'Pilih minimal satu barang untuk stok opname!'
                        });
                        return;
                    }
                    
                    items = allBarang
                        .filter(item => selectedCodes.includes(item.kode))
                        .map(item => ({
                            kode: item.kode,
                            plu: item.plu || '',
                            nama: item.nama,
                            kategori: item.kategori || 'Uncategorized',
                            kodeToko: item.kodeToko || '',
                            stokSistem: item.stok,
                            stokAktual: null,
                            hargaBeli: item.hargaBeli,
                            hargaJual: item.hargaJual,
                            keterangan: ''
                        }));
                }
                
                // Create opname object
                const newOpname = {
                    noOpname: noOpname,
                    tanggal: new Date().toISOString(),
                    petugas: username,
                    tipeOpname: opnameType,
                    kategori: kategori,
                    status: 'pending',
                    catatan: note,
                    items: items
                };
                
                // Save to localStorage
                riwayatOpname.push(newOpname);
                localStorage.setItem('stokOpname', JSON.stringify(riwayatOpname));
                
                // Close modal and show opname details
                document.getElementById('createOpnameModal').style.display = 'none';
                
                // Set as current opname and show detail view
                currentOpname = newOpname;
                showActiveOpname();
                
                // Update UI
                loadRiwayatOpname();
                updateSummary();
            }
            
            // Continue an existing pending opname
            function continueOpname(noOpname) {
                const opname = riwayatOpname.find(op => op.noOpname === noOpname);
                if (!opname || opname.status !== 'pending') return;
                
                currentOpname = opname;
                showActiveOpname();
            }
            
            // Show active opname details
            function showActiveOpname() {
                if (!currentOpname) return;
                
                // Show container
                const container = document.getElementById('detailOpnameContainer');
                container.style.display = 'block';
                
                // Fill header info
                document.getElementById('opnameNumber').textContent = currentOpname.noOpname;
                
                // Format date
                const opnameDate = new Date(currentOpname.tanggal);
                const formattedDate = opnameDate.toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(',', '');
                
                document.getElementById('opnameDate').textContent = formattedDate;
                
                // Set status text
                let statusText = 'Pending';
                switch (currentOpname.status) {
                    case 'pending':
                        statusText = 'Pending';
                        break;
                    case 'completed':
                        statusText = 'Selesai';
                        break;
                    case 'adjusted':
                        statusText = 'Disesuaikan';
                        break;
                }
                document.getElementById('opnameStatus').textContent = statusText;
                
                // Load detail table
                loadOpnameTable();
            }
            
            // Load opname details into table
            function loadOpnameTable() {
                if (!currentOpname) return;
                
                const tbody = document.querySelector('#tabelDetailOpname tbody');
                tbody.innerHTML = '';
                
                // Get filter values
                const filterKategori = document.getElementById('opnameFilterKategori').value;
                const filterBarang = document.getElementById('opnameFilterBarang').value.toLowerCase();
                const filterSelisih = document.getElementById('opnameFilterSelisih').value;
                
                // Filter items
                activeOpnameItems = [...currentOpname.items];
                
                // Apply category filter
                if (filterKategori !== 'all') {
                    activeOpnameItems = activeOpnameItems.filter(item => 
                        (item.kategori || 'Uncategorized') === filterKategori
                    );
                }
                
                // Apply item name/code filter
                if (filterBarang) {
                    activeOpnameItems = activeOpnameItems.filter(item => 
                        item.kode.toLowerCase().includes(filterBarang) || 
                        item.nama.toLowerCase().includes(filterBarang) ||
                        (item.plu && item.plu.toLowerCase().includes(filterBarang))
                    );
                }
                
                // Apply selisih filter (only for completed items)
                if (filterSelisih !== 'all' && currentOpname.status !== 'pending') {
                    activeOpnameItems = activeOpnameItems.filter(item => {
                        if (item.stokAktual === null) return false;
                        
                        const selisih = item.stokAktual - item.stokSistem;
                        if (filterSelisih === 'plus') return selisih > 0;
                        if (filterSelisih === 'minus') return selisih < 0;
                        if (filterSelisih === 'zero') return selisih === 0;
                        return true;
                    });
                }
                
                // Group by category
                const categories = ['A1', 'A2', 'A3', 'A4', 'A5', 'B1', 'B2', 'B3', 'B4', 'B5', 'B6', 'C1', 'C2', 'C3', 'C4', 'C5', 'C6', 'C7', 'Uncategorized'];
                
                categories.forEach(category => {
                    const categoryItems = activeOpnameItems.filter(item => 
                        (item.kategori || 'Uncategorized') === category
                    );
                    
                    if (categoryItems.length > 0) {
                        // Add category header
                        const headerRow = tbody.insertRow();
                        const headerCell = headerRow.insertCell(0);
                        headerCell.colSpan = 11;
                        headerCell.innerHTML = `<strong>Kategori: ${category}</strong>`;
                        headerCell.className = 'category-header';
                        
                        // Add items
                        categoryItems.forEach(item => {
                            const row = tbody.insertRow();
                            
                            // Calculate selisih if stokAktual is set
                            let selisih = null;
                            let selisihRupiah = null;
                            let selisihClass = '';
                            
                            if (item.stokAktual !== null) {
                                selisih = item.stokAktual - item.stokSistem;
                                selisihRupiah = selisih * item.hargaBeli;
                                
                                if (selisih > 0) {
                                    selisihClass = 'selisih-positif';
                                } else if (selisih < 0) {
                                    selisihClass = 'selisih-negatif';
                                } else {
                                    selisihClass = 'selisih-nol';
                                }
                            }
                            
                            // Create cells with data
                            const cells = [
                                item.kategori || 'Uncategorized',
                                item.kodeToko || '',
                                item.kode,
                                item.plu || '',
                                item.nama,
                                item.stokSistem
                            ];
                            
                            // Add cells to row
                            cells.forEach(cellValue => {
                                const cell = row.insertCell();
                                cell.textContent = cellValue;
                            });
                            
                            // Add stokAktual cell (input or value)
                            const stokAktualCell = row.insertCell();
                            if (currentOpname.status === 'pending') {
                                // Create input
                                const input = document.createElement('input');
                                input.type = 'number';
                                input.min = '0';
                                input.className = 'input-aktual';
                                input.dataset.kode = item.kode;
                                input.value = item.stokAktual !== null ? item.stokAktual : '';
                                input.onchange = (e) => {
                                    updateStokAktual(item.kode, parseInt(e.target.value) || 0);
                                };
                                stokAktualCell.appendChild(input);
                            } else {
                                // Show value
                                stokAktualCell.textContent = item.stokAktual;
                            }
                            
                            // Add selisih cell
                            const selisihCell = row.insertCell();
                            if (selisih !== null) {
                                selisihCell.textContent = selisih;
                                selisihCell.className = selisihClass;
                            } else {
                                selisihCell.textContent = '-';
                            }
                            
                            // Add hargaBeli cell
                            const hargaBeliCell = row.insertCell();
                            hargaBeliCell.textContent = formatRupiah(item.hargaBeli);
                            
                            // Add selisihRupiah cell
                            const selisihRupiahCell = row.insertCell();
                            if (selisihRupiah !== null) {
                                selisihRupiahCell.textContent = formatRupiah(selisihRupiah);
                                selisihRupiahCell.className = selisihClass;
                            } else {
                                selisihRupiahCell.textContent = '-';
                            }
                            
                            // Add keterangan cell
                            const keteranganCell = row.insertCell();
                            if (currentOpname.status === 'pending') {
                                // Create input
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.style.width = '100%';
                                input.dataset.kode = item.kode;
                                input.value = item.keterangan || '';
                                input.onchange = (e) => {
                                    updateKeterangan(item.kode, e.target.value);
                                };
                                keteranganCell.appendChild(input);
                            } else {
                                // Show value
                                keteranganCell.textContent = item.keterangan || '';
                            }
                        });
                    }
                });
                
                // Show/hide buttons based on status
                const saveBtn = document.getElementById('saveOpnameBtn');
                const completeBtn = document.getElementById('completeOpnameBtn');
                
                if (currentOpname.status === 'pending') {
                    saveBtn.style.display = 'block';
                    completeBtn.style.display = 'block';
                } else {
                    saveBtn.style.display = 'none';
                    completeBtn.style.display = 'none';
                }
            }
            
            // Update stokAktual value
            function updateStokAktual(kode, stokAktual) {
                if (!currentOpname) return;
                
                // Find and update the item
                const itemIndex = currentOpname.items.findIndex(item => item.kode === kode);
                if (itemIndex !== -1) {
                    currentOpname.items[itemIndex].stokAktual = stokAktual;
                }
            }
            
            // Update keterangan value
            function updateKeterangan(kode, keterangan) {
                if (!currentOpname) return;
                
                // Find and update the item
                const itemIndex = currentOpname.items.findIndex(item => item.kode === kode);
                if (itemIndex !== -1) {
                    currentOpname.items[itemIndex].keterangan = keterangan;
                }
            }
            
            // Save current opname changes
            function saveOpname() {
                if (!currentOpname || currentOpname.status !== 'pending') return;
                
                // Update opname in the list
                const index = riwayatOpname.findIndex(op => op.noOpname === currentOpname.noOpname);
                if (index !== -1) {
                    riwayatOpname[index] = currentOpname;
                    localStorage.setItem('stokOpname', JSON.stringify(riwayatOpname));
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil',
                        text: 'Data stok opname berhasil disimpan'
                    });
                }
            }
            
            // Complete the current opname
            function completeOpname() {
                if (!currentOpname || currentOpname.status !== 'pending') return;
                
                // Check if all items have stokAktual value
                const incomplete = currentOpname.items.some(item => item.stokAktual === null);
                if (incomplete) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Peringatan',
                        text: 'Semua stok aktual harus diisi sebelum menyelesaikan stok opname'
                    });
                    return;
                }
                
                // Update status to completed
                currentOpname.status = 'completed';
                
                // Update opname in the list
                const index = riwayatOpname.findIndex(op => op.noOpname === currentOpname.noOpname);
                if (index !== -1) {
                    riwayatOpname[index] = currentOpname;
                    localStorage.setItem('stokOpname', JSON.stringify(riwayatOpname));
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil',
                        text: 'Stok opname berhasil diselesaikan'
                    }).then(() => {
                        // Ask if user wants to adjust stock
                        Swal.fire({
                            title: 'Adjustment Stok',
                            text: 'Apakah Anda ingin menyesuaikan stok sesuai hasil opname?',
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: 'Ya, Sesuaikan',
                            cancelButtonText: 'Tidak'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                adjustOpname(currentOpname.noOpname);
                            } else {
                                // Reset current opname and reload history
                                currentOpname = null;
                                document.getElementById('detailOpnameContainer').style.display = 'none';
                                loadRiwayatOpname();
                                updateSummary();
                            }
                        });
                    });
                }
            }
            
            // Cancel current opname
            function cancelOpname() {
                if (!currentOpname) return;
                
                Swal.fire({
                    title: 'Batalkan Stok Opname',
                    text: 'Apakah Anda yakin ingin membatalkan stok opname ini?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ya, Batalkan',
                    cancelButtonText: 'Tidak'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Reset current opname and hide detail view
                        currentOpname = null;
                        document.getElementById('detailOpnameContainer').style.display = 'none';
                    }
                });
            }
            
            // Adjust stock based on opname results
            function adjustOpname(noOpname) {
                const opname = riwayatOpname.find(op => op.noOpname === noOpname);
                if (!opname || opname.status !== 'completed') return;
                
                Swal.fire({
                    title: 'Adjustment Stok',
                    text: 'Apakah Anda yakin ingin menyesuaikan stok sesuai hasil opname?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ya, Sesuaikan',
                    cancelButtonText: 'Tidak'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show loading
                        document.getElementById('loadingOverlay').style.display = 'flex';
                        
                        // Update stock in barang data
                        let barang = JSON.parse(localStorage.getItem('barang')) || [];
                        
                        opname.items.forEach(opnameItem => {
                            const barangIndex = barang.findIndex(item => item.kode === opnameItem.kode);
                            if (barangIndex !== -1) {
                                barang[barangIndex].stok = opnameItem.stokAktual;
                            }
                        });
                        
                        // Save updated barang to localStorage
                        localStorage.setItem('barang', JSON.stringify(barang));
                        
                        // Update opname status
                        opname.status = 'adjusted';
                        
                        // Update opname in the list
                        const index = riwayatOpname.findIndex(op => op.noOpname === opname.noOpname);
                        if (index !== -1) {
                            riwayatOpname[index] = opname;
                            localStorage.setItem('stokOpname', JSON.stringify(riwayatOpname));
                        }
                        
                        // Hide loading
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        // If this is the current opname, update UI
                        if (currentOpname && currentOpname.noOpname === opname.noOpname) {
                            currentOpname = opname;
                            showActiveOpname();
                        }
                        
                        // Hide history modal if open
                        document.getElementById('historyDetailModal').style.display = 'none';
                        
                        // Update UI
                        loadRiwayatOpname();
                        updateSummary();
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil',
                            text: 'Stok berhasil disesuaikan'
                        });
                    }
                });
            }
            
            // Delete opname
            function deleteOpname(noOpname) {
                Swal.fire({
                    title: 'Hapus Stok Opname',
                    text: 'Apakah Anda yakin ingin menghapus stok opname ini?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ya, Hapus',
                    cancelButtonText: 'Tidak'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Remove from riwayatOpname
                        const index = riwayatOpname.findIndex(op => op.noOpname === noOpname);
                        if (index !== -1) {
                            riwayatOpname.splice(index, 1);
                            localStorage.setItem('stokOpname', JSON.stringify(riwayatOpname));
                            
                            // If this is the current opname, reset
                            if (currentOpname && currentOpname.noOpname === noOpname) {
                                currentOpname = null;
                                document.getElementById('detailOpnameContainer').style.display = 'none';
                            }
                            
                            // Update UI
                            loadRiwayatOpname();
                            updateSummary();
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'Berhasil',
                                text: 'Stok opname berhasil dihapus'
                            });
                        }
                    }
                });
            }
            
            // Load items for selection in create modal
            function loadItemsForSelection() {
                const searchTerm = document.getElementById('searchItems').value.toLowerCase();
                const tbody = document.querySelector('#itemSelectionTable tbody');
                tbody.innerHTML = '';
                
                // Filter items
                filteredBarang = allBarang.filter(item => 
                    item.kode.toLowerCase().includes(searchTerm) || 
                    item.nama.toLowerCase().includes(searchTerm) ||
                    (item.plu && item.plu.toLowerCase().includes(searchTerm))
                );
                
                // Populate table
                filteredBarang.forEach(item => {
                    const row = tbody.insertRow();
                    
                    // Checkbox cell
                    const checkCell = row.insertCell();
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = item.kode;
                    checkCell.appendChild(checkbox);
                    
                    // Data cells
                    const cells = [
                        item.kode,
                        item.nama,
                        item.kategori || 'Uncategorized',
                        item.stok
                    ];
                    
                    // Add cells to row
                    cells.forEach(cellValue => {
                        const cell = row.insertCell();
                        cell.textContent = cellValue;
                    });
                });
            }
            
            // Event Listeners
            
            // Filter buttons
            document.getElementById('filterBtn').addEventListener('click', loadRiwayatOpname);
            document.getElementById('opnameFilterBtn').addEventListener('click', loadOpnameTable);
            
            // Create opname modal
            document.getElementById('createOpnameBtn').addEventListener('click', () => {
                // Reset form
                document.getElementById('opnameType').value = 'all';
                document.getElementById('categoryForm').style.display = 'none';
                document.getElementById('selectedItemsForm').style.display = 'none';
                document.getElementById('opnameNote').value = '';
                document.getElementById('itemSelectionTable').querySelector('tbody').innerHTML = '';
                
                // Show modal
                document.getElementById('createOpnameModal').style.display = 'block';
            });
            
            // Modal close buttons
            document.getElementById('closeCreateModal').addEventListener('click', () => {
                document.getElementById('createOpnameModal').style.display = 'none';
            });
            
            document.getElementById('closeHistoryModal').addEventListener('click', () => {
                document.getElementById('historyDetailModal').style.display = 'none';
            });
            
            // Create opname type change
            document.getElementById('opnameType').addEventListener('change', (e) => {
                const type = e.target.value;
                
                if (type === 'category') {
                    document.getElementById('categoryForm').style.display = 'block';
                    document.getElementById('selectedItemsForm').style.display = 'none';
                } else if (type === 'selected') {
                    document.getElementById('categoryForm').style.display = 'none';
                    document.getElementById('selectedItemsForm').style.display = 'block';
                    loadItemsForSelection();
                } else {
                    document.getElementById('categoryForm').style.display = 'none';
                    document.getElementById('selectedItemsForm').style.display = 'none';
                }
            });
            
            // Search items in selection table
            // Search items in selection table
            document.getElementById('searchItems').addEventListener('keyup', loadItemsForSelection);
            
            // Search in opname history
            document.getElementById('searchOpname').addEventListener('keyup', loadRiwayatOpname);
            
            // Modal action buttons
            document.getElementById('startOpnameBtn').addEventListener('click', createOpname);
            document.getElementById('cancelCreateBtn').addEventListener('click', () => {
                document.getElementById('createOpnameModal').style.display = 'none';
            });
            
            document.getElementById('closeHistoryDetailBtn').addEventListener('click', () => {
                document.getElementById('historyDetailModal').style.display = 'none';
            });
            
            // Opname detail action buttons
            document.getElementById('saveOpnameBtn').addEventListener('click', saveOpname);
            document.getElementById('completeOpnameBtn').addEventListener('click', completeOpname);
            document.getElementById('cancelOpnameBtn').addEventListener('click', cancelOpname);
            
            // Initialize
            loadData();
            
            // Check if there's a pending opname to continue
            const pendingOpname = riwayatOpname.find(op => op.status === 'pending');
            if (pendingOpname) {
                Swal.fire({
                    title: 'Stok Opname Pending',
                    text: `Ditemukan stok opname yang belum selesai (${pendingOpname.noOpname}). Apakah Anda ingin melanjutkan?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Ya, Lanjutkan',
                    cancelButtonText: 'Tidak'
                }).then((result) => {
                    if (result.isConfirmed) {
                        currentOpname = pendingOpname;
                        showActiveOpname();
                    }
                });
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>
