<!DOCTYPE html>
<html lang="id">
<head>
  
    <title>Pembuat Label Price Tag</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        :root {
            --primary-color: #4a6da7;
            --secondary-color: #f8f9fa;
            --accent-color: #ff6b6b;
            --text-color: #333;
            --border-color: #dee2e6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .search-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        button:hover {
            background-color: #3a5b8c;
        }

        .products-container {
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        thead {
            background-color: var(--primary-color);
            color: white;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        tbody tr:hover {
            background-color: var(--secondary-color);
        }

        .selected-row {
            background-color: #e6f7ff !important;
        }

        .checkbox-cell {
            text-align: center;
        }

        .price-tags-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .price-tag {
            border: 2px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            width: 250px;
            height: 150px;
            page-break-inside: avoid;
        }

        .price-tag-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 5px;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .price-tag-title {
            font-weight: bold;
            font-size: 18px;
            margin: 5px 0;
            text-align: center;
            height: 40px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .price-tag-price {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            margin-top: 10px;
        }

        .price-tag-footer {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-top: 10px;
            border-top: 1px dashed var(--border-color);
            padding-top: 5px;
        }

        .print-section {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 10px;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .price-tags-print-container, .price-tags-print-container * {
                visibility: visible;
            }
            .price-tags-print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .container {
                box-shadow: none;
                border: none;
            }
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color);
        }

        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
            margin-bottom: -2px;
        }

        .tab-content {
            display: none;
            padding: 20px 0;
        }

        .tab-content.active {
            display: block;
        }

        .layout-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .layout-option {
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s;
        }

        .layout-option.active {
            border-color: var(--primary-color);
            background-color: rgba(74, 109, 167, 0.1);
        }

        .layout-option-image {
            width: 80px;
            height: 60px;
            background-color: #eee;
            margin-bottom: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .layout-settings {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: 4px;
        }

        .settings-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .setting-item {
            flex: 1;
            min-width: 200px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .setting-item input, .setting-item select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s, fadeOut 0.5s 2.5s;
            animation-fill-mode: forwards;
        }

        @keyframes slideIn {
            from {
                right: -300px;
                opacity: 0;
            }
            to {
                right: 20px;
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-left: 5px;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 30px;
            color: #888;
            font-style: italic;
        }
        
        
        
           .price-tag-discount-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #e63946;
        color: white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transform: rotate(15deg);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 2;
    }
    
    .price-tag-discount-timer {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(230, 57, 70, 0.1);
        color: #e63946;
        padding: 3px;
        font-size: 10px;
        text-align: center;
        border-top: 1px dashed rgba(230, 57, 70, 0.3);
    }
    
    .price-tag-discount {
        background: linear-gradient(to bottom right, #fff5f7, white);
        border: 2px solid #fecdd3 !important;
        position: relative;
        overflow: hidden;
    }
    
    .price-tag-discount::before {
        content: '';
        position: absolute;
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        background: linear-gradient(135deg, rgba(230, 57, 70, 0.1) 0%, rgba(230, 57, 70, 0) 60%);
        z-index: 0;
    }
    
    .price-tag-discount > * {
        position: relative;
        z-index: 1;
    }
    
    /* Style untuk modal pilih diskon */
    .discount-selection-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        font-size: 14px;
    }
    .discount-selection-table th, 
    .discount-selection-table td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
    }
    .discount-selection-table th {
        background-color: #f1f5f9;
        font-weight: 600;
        color: #334155;
    }
    .discount-selection-table .checkbox-cell {
        text-align: center;
        width: 40px;
    }
    .discount-checkbox {
        cursor: pointer;
    }
    .discount-selection-table tr:hover {
        background-color: #f8fafc;
    }
    .select-all-container {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }
    .select-all-container input {
        margin-right: 8px;
    }
    .select-all-container label {
        font-weight: 500;
        cursor: pointer;
    }
        
    </style>
</head>
<body>
    <div class="container">
        <h1>Pembuat Label Price Tag</h1>

        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" data-tab="browse">Pilih Produk</button>
                <button class="tab" data-tab="preview">Preview Label</button>
                <button class="tab" data-tab="settings">Pengaturan</button>
            </div>

            <div id="browse" class="tab-content active">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Cari nama barang atau kode...">
                    <button id="searchButton"><i class="fas fa-search"></i> Cari</button>
                </div>

                <div class="products-container">
                    <table id="productsTable">
                        <thead>
                            <tr>
                                <th class="checkbox-cell"><input type="checkbox" id="selectAll"></th>
                                <th>Kode Toko</th>
                                <th>Kode Barang</th>
                                <th>PLU</th>
                                <th>Nama Barang</th>
                                <th>Kategori</th>
                                <th>Harga</th>
                                <th>Stok</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody"></tbody>
                    </table>
                    <div id="noDataMessage" class="no-data" style="display: none;">
                        Tidak ada data produk yang tersedia. Silakan tambahkan produk terlebih dahulu.
                    </div>
                </div>

                <button id="generateButton"><i class="fas fa-tags"></i> Buat Label</button>
            </div>

            <div id="preview" class="tab-content">
                <div class="layout-options">
                    <div class="layout-option active" data-layout="standard">
                        <div class="layout-option-image">
                            <i class="fas fa-tag fa-2x"></i>
                        </div>
                        <span>Standar</span>
                    </div>
                    <div class="layout-option" data-layout="compact">
                        <div class="layout-option-image">
                            <i class="fas fa-ticket-alt fa-2x"></i>
                        </div>
                        <span>Kompak</span>
                    </div>
                    <div class="layout-option" data-layout="detailed">
                        <div class="layout-option-image">
                            <i class="fas fa-receipt fa-2x"></i>
                        </div>
                        <span>Detail</span>
                    </div>
                </div>

               <div class="print-section">
    <button id="printButton"><i class="fas fa-print"></i> Cetak</button>
    
    <button id="downloadPdfButton"><i class="fas fa-file-pdf"></i> Download PDF</button>
</div>



<template id="discount-selection-modal">
    <div class="select-all-container">
        <input type="checkbox" id="selectAllDiscounts">
        <label for="selectAllDiscounts">Pilih Semua</label>
    </div>
    <div style="max-height: 400px; overflow-y: auto;">
        <table class="discount-selection-table">
            <thead>
                <tr>
                    <th class="checkbox-cell"></th>
                    <th>Kode</th>
                    <th>Nama Barang</th>
                    <th>Harga Asli</th>
                    <th>Harga Diskon</th>
                    <th>Diskon</th>
                    <th>Berakhir</th>
                </tr>
            </thead>
            <tbody id="discountTableBody">
                <!-- Item diskon akan ditambahkan secara dinamis -->
            </tbody>
        </table>
    </div>
</template>


                <div id="priceTagsContainer" class="price-tags-container price-tags-print-container">
                    <!-- Price tags will be generated here -->
                </div>
            </div>

            <div id="settings" class="tab-content">
                <h2>Pengaturan Label</h2>
                <div class="layout-settings">
                    <div class="settings-row">
                        <div class="setting-item">
                            <label for="priceTagWidth">Lebar Label (mm)
                                <span class="tooltip"><i class="fas fa-info-circle"></i>
                                    <span class="tooltiptext">Lebar label price tag dalam satuan milimeter</span>
                                </span>
                            </label>
                            <input type="number" id="priceTagWidth" value="60" min="30" max="200">
                        </div>
                        <div class="setting-item">
                            <label for="priceTagHeight">Tinggi Label (mm)
                                <span class="tooltip"><i class="fas fa-info-circle"></i>
                                    <span class="tooltiptext">Tinggi label price tag dalam satuan milimeter</span>
                                </span>
                            </label>
                            <input type="number" id="priceTagHeight" value="40" min="20" max="150">
                        </div>
                    </div>
                    <div class="settings-row">
                        <div class="setting-item">
                            <label for="fontSize">Ukuran Font Harga
                                <span class="tooltip"><i class="fas fa-info-circle"></i>
                                    <span class="tooltiptext">Ukuran font untuk tampilan harga pada label</span>
                                </span>
                            </label>
                            <input type="number" id="fontSize" value="18" min="12" max="36">
                        </div>
                        <div class="setting-item">
                            <label for="labelsPerPage">Label per Halaman
                                <span class="tooltip"><i class="fas fa-info-circle"></i>
                                    <span class="tooltiptext">Jumlah label yang akan dicetak dalam satu halaman</span>
                                </span>
                            </label>
                            <input type="number" id="labelsPerPage" value="12" min="1" max="50">
                        </div>
                    </div>
                    <div class="settings-row">
                        <div class="setting-item">
                            <label for="borderType">Jenis Border
                                <span class="tooltip"><i class="fas fa-info-circle"></i>
                                    <span class="tooltiptext">Jenis garis tepi pada label price tag</span>
                                </span>
                            </label>
                            <select id="borderType">
                                <option value="solid">Solid</option>
                                <option value="dashed">Dashed</option>
                                <option value="dotted">Dotted</option>
                                <option value="none">Tanpa Border</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label for="paperSize">Ukuran Kertas
                                <span class="tooltip"><i class="fas fa-info-circle"></i>
                                    <span class="tooltiptext">Ukuran kertas yang digunakan untuk mencetak label</span>
                                </span>
                            </label>
                            <select id="paperSize">
                                <option value="a4">A4</option>
                                <option value="letter">Letter</option>
                                <option value="legal">Legal</option>
                            </select>
                        </div>
                    </div>
                    <button id="saveSettingsButton"><i class="fas fa-save"></i> Simpan Pengaturan</button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        Pengaturan berhasil disimpan!
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
  document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const productsTableBody = document.getElementById('productsTableBody');
    const selectAllCheckbox = document.getElementById('selectAll');
    const generateButton = document.getElementById('generateButton');
    const priceTagsContainer = document.getElementById('priceTagsContainer');
    const printButton = document.getElementById('printButton');
    const downloadPdfButton = document.getElementById('downloadPdfButton');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const layoutOptions = document.querySelectorAll('.layout-option');
    const saveSettingsButton = document.getElementById('saveSettingsButton');
    const notification = document.getElementById('notification');
    const loading = document.getElementById('loading');
    const noDataMessage = document.getElementById('noDataMessage');

    // Settings
    let settings = {
        priceTagWidth: 60,
        priceTagHeight: 40,
        fontSize: 18,
        labelsPerPage: 12,
        borderType: 'solid',
        paperSize: 'a4',
        layout: 'standard'
    };

    // Load settings from localStorage
    const savedSettings = localStorage.getItem('priceTagSettings');
    if (savedSettings) {
        settings = JSON.parse(savedSettings);
        
        // Apply saved settings to form
        document.getElementById('priceTagWidth').value = settings.priceTagWidth;
        document.getElementById('priceTagHeight').value = settings.priceTagHeight;
        document.getElementById('fontSize').value = settings.fontSize;
        document.getElementById('labelsPerPage').value = settings.labelsPerPage;
        document.getElementById('borderType').value = settings.borderType;
        document.getElementById('paperSize').value = settings.paperSize;
        
        // Apply saved layout option
        layoutOptions.forEach(option => {
            if (option.dataset.layout === settings.layout) {
                option.classList.add('active');
            } else {
                option.classList.remove('active');
            }
        });
    }

    // Selected products for price tag generation
    let selectedProducts = [];

    // Load products from localStorage
  function loadProducts() {
    const barang = JSON.parse(localStorage.getItem('barang')) || [];
    const diskon = JSON.parse(localStorage.getItem('diskon')) || [];
    
    // Map discount data to products
    const productsWithDiscounts = barang.map(product => {
        // Get current date for discount validation
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Find active discounts for this product
        const activeDiscount = diskon.find(d => {
            const startDate = new Date(d.tanggalMulai);
            const endDate = new Date(d.tanggalBerakhir);
            endDate.setHours(23, 59, 59, 999);
            
            return d.kode === product.kode && 
                   startDate <= today && 
                   endDate >= today && 
                   d.status === 'active';
        });
        
        // Return product with discount info if available
        return {
            ...product,
            hasDiscount: !!activeDiscount,
            discountInfo: activeDiscount || null
        };
    });
    
    if (productsWithDiscounts.length === 0) {
        noDataMessage.style.display = 'block';
        document.getElementById('productsTable').style.display = 'none';
    } else {
        noDataMessage.style.display = 'none';
        document.getElementById('productsTable').style.display = 'table';
        displayProducts(productsWithDiscounts);
    }
}

  // Display products in the table with discount info
function displayProducts(products) {
    productsTableBody.innerHTML = '';
    
    products.forEach(product => {
        const row = document.createElement('tr');
        
        // Checkbox cell
        const checkboxCell = document.createElement('td');
        checkboxCell.className = 'checkbox-cell';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.dataset.kode = product.kode;
        checkbox.addEventListener('change', toggleProductSelection);
        checkboxCell.appendChild(checkbox);
        
        // Create data cells
        const cells = [
            checkboxCell,
            createCell(product.kodeToko || '-'),
            createCell(product.kode || '-'),
            createCell(product.plu || '-'),
            createCell(product.nama || '-'),
            createCell(product.kategori || '-')
        ];
        
        // Price cell with discount indication
        const priceCell = document.createElement('td');
        if (product.hasDiscount) {
            priceCell.innerHTML = `
                <span style="text-decoration: line-through; color: #999;">${formatRupiah(product.hargaJual)}</span>
                <span style="color: #e63946; font-weight: bold;">${formatRupiah(product.discountInfo.hargaDiskon)}</span>
                <span style="background-color: #e6394620; font-size: 0.8em; padding: 2px 4px; border-radius: 3px; margin-left: 4px;">${product.discountInfo.persenDiskon}%</span>
            `;
        } else {
            priceCell.textContent = formatRupiah(product.hargaJual) || '-';
        }
        cells.push(priceCell);
        
        // Stock cell
        cells.push(createCell(product.stok || '0'));
        
        // Add cells to row
        cells.forEach(cell => row.appendChild(cell));
        
        // Add row to table body
        productsTableBody.appendChild(row);
    });
}

    // Helper function to create a table cell
    function createCell(text) {
        const cell = document.createElement('td');
        cell.textContent = text;
        return cell;
    }

    // Format Rupiah
    function formatRupiah(amount) {
        if (!amount) return 'Rp 0';
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(amount);
    }

 // Toggle product selection (updated to handle discount info)
function toggleProductSelection(e) {
    const kode = e.target.dataset.kode;
    const isChecked = e.target.checked;
    
    const barang = JSON.parse(localStorage.getItem('barang')) || [];
    const diskon = JSON.parse(localStorage.getItem('diskon')) || [];
    
    // Find the product
    const product = barang.find(item => item.kode === kode);
    
    if (product) {
        // Check for active discount
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const activeDiscount = diskon.find(d => {
            const startDate = new Date(d.tanggalMulai);
            const endDate = new Date(d.tanggalBerakhir);
            endDate.setHours(23, 59, 59, 999);
            
            return d.kode === product.kode && 
                   startDate <= today && 
                   endDate >= today && 
                   d.status === 'active';
        });
        
        if (isChecked) {
            const productWithDiscount = {
                ...product,
                hasDiscount: !!activeDiscount,
                discountInfo: activeDiscount || null
            };
            selectedProducts.push(productWithDiscount);
        } else {
            selectedProducts = selectedProducts.filter(item => item.kode !== kode);
        }
    }
    
    // Highlight selected rows
    const row = e.target.closest('tr');
    if (isChecked) {
        row.classList.add('selected-row');
    } else {
        row.classList.remove('selected-row');
    }
    
    // Update "Select All" checkbox state
    updateSelectAllCheckbox();
}
    // Update "Select All" checkbox state
    function updateSelectAllCheckbox() {
        const checkboxes = productsTableBody.querySelectorAll('input[type="checkbox"]');
        const checkedCount = productsTableBody.querySelectorAll('input[type="checkbox"]:checked').length;
        
        selectAllCheckbox.checked = checkboxes.length > 0 && checkedCount === checkboxes.length;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    }

    // Handle "Select All" checkbox
    selectAllCheckbox.addEventListener('change', function() {
        const checkboxes = productsTableBody.querySelectorAll('input[type="checkbox"]');
        const isChecked = this.checked;
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            
            // Trigger change event to update selectedProducts array
            const event = new Event('change');
            checkbox.dispatchEvent(event);
        });
    });

    // Search products
    searchButton.addEventListener('click', searchProducts);
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchProducts();
        }
    });

    function searchProducts() {
        const searchText = searchInput.value.toLowerCase();
        const barang = JSON.parse(localStorage.getItem('barang')) || [];
        
        if (searchText.trim() === '') {
            displayProducts(barang);
        } else {
            const filteredProducts = barang.filter(product => 
                (product.nama && product.nama.toLowerCase().includes(searchText)) ||
                (product.kode && product.kode.toLowerCase().includes(searchText)) ||
                (product.plu && product.plu.toLowerCase().includes(searchText)) ||
                (product.kodeToko && product.kodeToko.toLowerCase().includes(searchText))
            );
            
            displayProducts(filteredProducts);
        }
    }

    // Generate price tags
    generateButton.addEventListener('click', function() {
        if (selectedProducts.length === 0) {
            alert('Silakan pilih minimal satu produk untuk membuat label price tag.');
            return;
        }
        
        generatePriceTags();
        
        // Switch to preview tab
        switchTab(document.querySelector('.tab[data-tab="preview"]'));
    });

    // Generate price tags based on selected products and settings
    
function generatePriceTags() {
    priceTagsContainer.innerHTML = '';
    
    // Apply settings to container with improved sizing calculation
    const pxWidth = Math.round(settings.priceTagWidth * 3.78); // Convert mm to px (96dpi)
    const pxHeight = Math.round(settings.priceTagHeight * 3.78); // Convert mm to px (96dpi)
    
    // Improve grid layout with better spacing
    priceTagsContainer.style.gridTemplateColumns = `repeat(auto-fill, minmax(${pxWidth}px, 1fr))`;
    priceTagsContainer.style.gap = '15px';
    
    selectedProducts.forEach(product => {
        const priceTag = document.createElement('div');
        priceTag.className = 'price-tag';
        priceTag.style.width = `${pxWidth}px`;
        priceTag.style.height = `${pxHeight}px`;
        priceTag.style.padding = '10px';
        priceTag.style.boxSizing = 'border-box';
        priceTag.style.display = 'flex';
        priceTag.style.flexDirection = 'column';
        priceTag.style.justifyContent = 'space-between';
        priceTag.style.backgroundColor = '#ffffff';
        priceTag.style.borderRadius = '8px';
        priceTag.style.overflow = 'hidden';
        
        // Add nice visuals depending on border type
        if (settings.borderType === 'none') {
            priceTag.style.boxShadow = '0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23)';
        } else {
            priceTag.style.border = `2px ${settings.borderType} var(--border-color)`;
        }
        
        let priceTagContent = '';
        
        // Enhanced layouts with better design and responsiveness
        switch(settings.layout) {
            case 'compact':
                priceTagContent = `
                    <div class="price-tag-header" style="display: flex; justify-content: space-between; font-size: ${Math.max(8, settings.fontSize - 10)}px; color: #555; background-color: #f8f9fa; padding: 5px; margin: -10px -10px 8px -10px; border-bottom: 1px solid #e9ecef;">
                        <span>${product.kodeToko || '-'}</span>
                        <span>${product.kode || '-'}</span>
                    </div>
                    <div class="price-tag-title" style="font-size: ${Math.max(10, settings.fontSize - 7)}px; font-weight: bold; margin: 3px 0; text-align: center; word-wrap: break-word; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${product.nama || '-'}</div>
                    ${generatePriceContent(product, settings.fontSize, 'compact')}
                `;
                break;
                
            case 'detailed':
                priceTagContent = `
                    <div class="price-tag-header" style="display: flex; justify-content: space-between; font-size: ${Math.max(8, settings.fontSize - 10)}px; color: #555; background-color: #f8f9fa; padding: 5px; margin: -10px -10px 8px -10px; border-bottom: 1px solid #e9ecef;">
                        <span style="font-weight: 500;">Toko: ${product.kodeToko || '-'}</span>
                        <span style="font-weight: 500;">Kode: ${product.kode || '-'}</span>
                    </div>
                    <div class="price-tag-title" style="font-size: ${Math.max(10, settings.fontSize - 7)}px; font-weight: bold; margin: 3px 0; text-align: center; word-wrap: break-word; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${product.nama || '-'}</div>
                    ${generatePriceContent(product, settings.fontSize, 'detailed')}
                    <div class="price-tag-footer" style="display: flex; justify-content: space-between; font-size: ${Math.max(8, settings.fontSize - 10)}px; color: #555; margin-top: 5px; background-color: #f8f9fa; padding: 5px; margin: 8px -10px -10px -10px; border-top: 1px solid #e9ecef;">
                        <span style="font-weight: 500;">Kat: ${product.kategori || '-'}</span>
                        <span style="font-weight: 500;">PLU: ${product.plu || '-'}</span>
                    </div>
                `;
                break;
                
            default: // Modern standard layout
                priceTagContent = `
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--primary-color), #8da9cf);"></div>
                    <div class="price-tag-header" style="display: flex; justify-content: space-between; font-size: ${Math.max(8, settings.fontSize - 10)}px; color: #6c757d; padding: 2px 0; margin-top: 3px;">
                        <span style="font-weight: 500;">${product.kodeToko || '-'}</span>
                        <span style="font-weight: 500;">${product.kode || '-'}</span>
                    </div>
                    <div class="price-tag-title" style="font-size: ${Math.max(10, settings.fontSize - 7)}px; font-weight: bold; margin: 10px 0; text-align: center; word-wrap: break-word; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: #495057;">${product.nama || '-'}</div>
                    ${generatePriceContent(product, settings.fontSize, 'standard')}
                    <div class="price-tag-footer" style="display: flex; justify-content: center; font-size: ${Math.max(8, settings.fontSize - 10)}px; color: #6c757d; margin-top: auto; padding-top: 5px; border-top: 1px dashed #e9ecef;">
                        <span style="font-weight: 500;">PLU: ${product.plu || '-'}</span>
                    </div>
                `;
        }
        
        priceTag.innerHTML = priceTagContent;
        priceTagsContainer.appendChild(priceTag);
    });
    
    // Add print-friendly styles
    const styleElement = document.getElementById('print-styles') || document.createElement('style');
    if (!document.getElementById('print-styles')) {
        styleElement.id = 'print-styles';
        document.head.appendChild(styleElement);
    }
    
    styleElement.textContent = `
        @media print {
            body * {
                visibility: hidden;
            }
            #priceTagsContainer, #priceTagsContainer * {
                visibility: visible;
            }
            #priceTagsContainer {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(${settings.priceTagWidth * 3.78}px, 1fr));
                gap: 5mm;
                padding: 5mm;
            }
            .price-tag {
                break-inside: avoid;
                page-break-inside: avoid;
                box-shadow: none !important;
                border: ${settings.borderType === 'none' ? '1px dashed #ccc' : `2px ${settings.borderType} var(--border-color)`};
            }
        }
    `;
}

function formatTanggal(tanggal) {
    if (!tanggal) return '-';
    return new Date(tanggal).toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
    });
}



function generatePriceContent(product, fontSize, layout) {
    if (!product.hasDiscount) {
        // Regular price (no discount)
        switch(layout) {
            case 'compact':
                return `<div class="price-tag-price" style="font-size: ${fontSize}px; font-weight: bold; text-align: center; color: #e63946; background-color: #f8f9fa; padding: 5px; margin: 8px -10px -10px -10px; border-top: 1px solid #e9ecef;">${formatRupiah(product.hargaJual)}</div>`;
            
            case 'detailed':
                return `<div class="price-tag-price" style="font-size: ${fontSize}px; font-weight: bold; text-align: center; color: #e63946; margin: 5px 0; padding: 5px; border-radius: 4px; background-color: #fff5f5;">${formatRupiah(product.hargaJual)}</div>`;
            
            default: // standard
                return `<div class="price-tag-price" style="font-size: ${fontSize}px; font-weight: bold; text-align: center; color: #e63946; background-color: #f8f9fa; padding: 8px 5px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 5px;">${formatRupiah(product.hargaJual)}</div>`;
        }
    } else {
        // Discounted price
        const discountInfo = product.discountInfo;
        const discountPeriod = `${formatTanggal(discountInfo.tanggalMulai)} - ${formatTanggal(discountInfo.tanggalBerakhir)}`;
        
        switch(layout) {
            case 'compact':
                return `
                    <div style="text-align: center; background-color: #fff2f2; border-radius: 4px; padding: 3px 0; margin: 0 -5px;">
                        <div style="font-size: ${fontSize - 6}px; text-decoration: line-through; color: #888;">${formatRupiah(product.hargaJual)}</div>
                        <div style="font-size: ${fontSize}px; font-weight: bold; color: #e63946;">${formatRupiah(discountInfo.hargaDiskon)}</div>
                        <div style="font-size: ${fontSize - 10}px; color: #666; margin-top: 2px;">${discountInfo.persenDiskon}% s/d ${formatTanggal(discountInfo.tanggalBerakhir)}</div>
                    </div>
                `;
            
            case 'detailed':
                return `
                    <div style="background-color: #fff2f2; border-radius: 4px; padding: 5px; text-align: center;">
                        <div style="position: relative; display: inline-block; margin-bottom: 4px;">
                            <span style="font-size: ${fontSize - 4}px; text-decoration: line-through; color: #888;">${formatRupiah(product.hargaJual)}</span>
                            <span style="position: absolute; top: -3px; right: -30px; background-color: #e63946; color: white; border-radius: 50%; font-size: ${fontSize - 10}px; padding: 3px 5px; transform: rotate(15deg);">-${discountInfo.persenDiskon}%</span>
                        </div>
                        <div style="font-size: ${fontSize}px; font-weight: bold; color: #e63946;">${formatRupiah(discountInfo.hargaDiskon)}</div>
                        <div style="font-size: ${fontSize - 10}px; color: #666; margin-top: 3px;">Periode: ${discountPeriod}</div>
                    </div>
                `;
            
            default: // standard
                return `
                    <div style="background-color: #fff5f5; border-radius: 6px; padding: 8px 5px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
                        <div style="font-size: ${fontSize - 5}px; text-decoration: line-through; color: #888;">${formatRupiah(product.hargaJual)}</div>
                        <div style="font-size: ${fontSize}px; font-weight: bold; color: #e63946; margin: 4px 0;">${formatRupiah(discountInfo.hargaDiskon)}</div>
                        <div style="display: inline-block; background-color: #e63946; color: white; font-size: ${fontSize - 10}px; padding: 2px 6px; border-radius: 4px; margin-top: 2px;">Diskon ${discountInfo.persenDiskon}%</div>
                        <div style="font-size: ${fontSize - 10}px; color: #666; margin-top: 4px;">Berlaku s/d ${formatTanggal(discountInfo.tanggalBerakhir)}</div>
                    </div>
                `;
        }
    }
}





function generateBatchLabels(count) {
    if (selectedProducts.length === 0) {
        alert('Silakan pilih minimal satu produk untuk membuat label batch.');
        return;
    }
    
    // Clear existing price tags
    priceTagsContainer.innerHTML = '';
    
    // Apply settings to container
    const pxWidth = Math.round(settings.priceTagWidth * 3.78);
    const pxHeight = Math.round(settings.priceTagHeight * 3.78);
    
    priceTagsContainer.style.gridTemplateColumns = `repeat(auto-fill, minmax(${pxWidth}px, 1fr))`;
    priceTagsContainer.style.gap = '15px';
    
    // Generate multiple labels for each product based on count
    selectedProducts.forEach(product => {
        for (let i = 0; i < count; i++) {
            const priceTag = document.createElement('div');
            priceTag.className = 'price-tag';
            priceTag.style.width = `${pxWidth}px`;
            priceTag.style.height = `${pxHeight}px`;
            priceTag.style.padding = '10px';
            priceTag.style.boxSizing = 'border-box';
            priceTag.style.display = 'flex';
            priceTag.style.flexDirection = 'column';
            priceTag.style.justifyContent = 'space-between';
            priceTag.style.backgroundColor = '#ffffff';
            priceTag.style.borderRadius = '8px';
            priceTag.style.overflow = 'hidden';
            
            // Add nice visuals depending on border type
            if (settings.borderType === 'none') {
                priceTag.style.boxShadow = '0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23)';
            } else {
                priceTag.style.border = `2px ${settings.borderType} var(--border-color)`;
            }
            
            let priceTagContent = '';
            
            // Use same layout logic as in generatePriceTags
            switch(settings.layout) {
                case 'compact':
                    priceTagContent = `
                        <div class="price-tag-header" style="display: flex; justify-content: space-between; font-size: ${Math.max(8, settings.fontSize - 10)}px; color: #555; background-color: #f8f9fa; padding: 5px; margin: -10px -10px 8px -10px; border-bottom: 1px solid #e9ecef;">
                            <span>${product.kodeToko || '-'}</span>
                            <span>${product.kode || '-'}</span>
                        </div>
                        <div class="price-tag-title" style="font-size: ${Math.max(10, settings.fontSize - 7)}px; font-weight: bold; margin: 3px 0; text-align: center; word-wrap: break-word; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${product.nama || '-'}</div>
                        ${generatePriceContent(product, settings.fontSize, 'compact')}
                    `;
                    break;
                    
                case 'detailed':
                    priceTagContent = `
                        <div class="price-tag-header" style="display: flex; justify-content: space-between; font-size: ${Math.max(8, settings.fontSize - 10)}px; color: #555; background-color: #f8f9fa; padding: 5px; margin: -10px -10px 8px -10px; border-bottom: 1px solid #e9ecef;">
                            <span style="font-weight: 500;">Toko: ${product.kodeToko || '-'}</span>
                            <span style="font-weight: 500;">Kode: ${product.kode || '-'}</span>
                        </div>
                        <div class="price-tag-title" style="font-size: ${Math.max(10, settings.fontSize - 7)}px; font-weight: bold; margin: 3px 0; text-align: center; word-wrap: break-word; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${product.nama || '-'}</div>
                        ${generatePriceContent(product, settings.fontSize, 'detailed')}
                        <div class="price-tag-footer" style="display: flex; justify-content: space-between; font-size: ${Math.max(8, settings.fontSize - 10)}px; color: #555; margin-top: 5px; background-color: #f8f9fa; padding: 5px; margin: 8px -10px -10px -10px; border-top: 1px solid #e9ecef;">
                            <span style="font-weight: 500;">Kat: ${product.kategori || '-'}</span>
                            <span style="font-weight: 500;">PLU: ${product.plu || '-'}</span>
                        </div>
                    `;
                    break;
                    
                default: // Modern standard layout
                    priceTagContent = `
                        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--primary-color), #8da9cf);"></div>
                        <div class="price-tag-header" style="display: flex; justify-content: space-between; font-size: ${Math.max(8, settings.fontSize - 10)}px; color: #6c757d; padding: 2px 0; margin-top: 3px;">
                            <span style="font-weight: 500;">${product.kodeToko || '-'}</span>
                            <span style="font-weight: 500;">${product.kode || '-'}</span>
                        </div>
                        <div class="price-tag-title" style="font-size: ${Math.max(10, settings.fontSize - 7)}px; font-weight: bold; margin: 10px 0; text-align: center; word-wrap: break-word; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: #495057;">${product.nama || '-'}</div>
                        ${generatePriceContent(product, settings.fontSize, 'standard')}
                        <div class="price-tag-footer" style="display: flex; justify-content: center; font-size: ${Math.max(8, settings.fontSize - 10)}px; color: #6c757d; margin-top: auto; padding-top: 5px; border-top: 1px dashed #e9ecef;">
                            <span style="font-weight: 500;">PLU: ${product.plu || '-'}</span>
                        </div>
                    `;
            }
            
            priceTag.innerHTML = priceTagContent;
            priceTagsContainer.appendChild(priceTag);
        }
    });
}
// Function to add new layout options
function addNewLayoutOptions() {
    const layoutOptionsContainer = document.querySelector('.layout-options');
    if (!layoutOptionsContainer) return;
    
    // Clear existing layout options
    layoutOptionsContainer.innerHTML = '';
    
    // Define new layout options
    const layouts = [
        { id: 'standard', icon: 'fa-tag', name: 'Standar' },
        { id: 'compact', icon: 'fa-ticket-alt', name: 'Kompak' },
        { id: 'detailed', icon: 'fa-receipt', name: 'Detail' },
        { id: 'modern', icon: 'fa-star', name: 'Modern' },
        { id: 'elegant', icon: 'fa-gem', name: 'Elegant' }
    ];
    
    // Add new layout options to container
    layouts.forEach(layout => {
        const option = document.createElement('div');
        option.className = `layout-option ${layout.id === settings.layout ? 'active' : ''}`;
        option.dataset.layout = layout.id;
        option.innerHTML = `
            <div class="layout-option-image">
                <i class="fas ${layout.icon} fa-2x"></i>
            </div>
            <span>${layout.name}</span>
        `;
        
        // Add click event to toggle layout
        option.addEventListener('click', function() {
            // Remove active class from all options
            document.querySelectorAll('.layout-option').forEach(opt => opt.classList.remove('active'));
            
            // Add active class to clicked option
            this.classList.add('active');
            
            // Update settings
            settings.layout = this.dataset.layout;
            
            // Regenerate price tags with new layout
            generatePriceTags();
        });
        
        layoutOptionsContainer.appendChild(option);
    });
}

// Function to initialize new price tag styles and color schemes
function initPriceTagStyles() {
    // Add new color scheme options to settings
    const layoutSettings = document.querySelector('.layout-settings');
    if (!layoutSettings) return;
    
    // Create color scheme selection
    const colorSchemeRow = document.createElement('div');
    colorSchemeRow.className = 'settings-row';
    colorSchemeRow.innerHTML = `
        <div class="setting-item">
            <label for="colorScheme">Skema Warna
                <span class="tooltip"><i class="fas fa-info-circle"></i>
                    <span class="tooltiptext">Pilih skema warna untuk price tag</span>
                </span>
            </label>
            <select id="colorScheme">
                <option value="blue">Biru (Default)</option>
                <option value="green">Hijau</option>
                <option value="red">Merah</option>
                <option value="purple">Ungu</option>
                <option value="teal">Teal</option>
            </select>
        </div>
        <div class="setting-item">
            <label for="tagStyle">Gaya Label
                <span class="tooltip"><i class="fas fa-info-circle"></i>
                    <span class="tooltiptext">Pilih gaya tampilan untuk price tag</span>
                </span>
            </label>
            <select id="tagStyle">
                <option value="classic">Classic</option>
                <option value="modern">Modern</option>
                <option value="minimalist">Minimalist</option>
                <option value="bordered">Bordered</option>
                <option value="shadow">Shadow</option>
            </select>
        </div>
    `;
    
    // Add to layout settings before the save button
    const saveButton = document.getElementById('saveSettingsButton');
    if (saveButton) {
        layoutSettings.insertBefore(colorSchemeRow, saveButton.parentNode);
    } else {
        layoutSettings.appendChild(colorSchemeRow);
    }
    
    // Update saved settings to include new options
    if (!settings.colorScheme) settings.colorScheme = 'blue';
    if (!settings.tagStyle) settings.tagStyle = 'classic';
    
    // Populate selects with saved values if available
    const colorSchemeSelect = document.getElementById('colorScheme');
    const tagStyleSelect = document.getElementById('tagStyle');
    if (colorSchemeSelect) colorSchemeSelect.value = settings.colorScheme;
    if (tagStyleSelect) tagStyleSelect.value = settings.tagStyle;
    
    // Update save settings function to include new options
    const originalSaveSettingsButton = saveSettingsButton.cloneNode(true);
    saveSettingsButton.parentNode.replaceChild(originalSaveSettingsButton, saveSettingsButton);
    originalSaveSettingsButton.addEventListener('click', function() {
        // Get values from form (original logic)
        settings.priceTagWidth = parseInt(document.getElementById('priceTagWidth').value) || 60;
        settings.priceTagHeight = parseInt(document.getElementById('priceTagHeight').value) || 40;
        settings.fontSize = parseInt(document.getElementById('fontSize').value) || 18;
        settings.labelsPerPage = parseInt(document.getElementById('labelsPerPage').value) || 12;
        settings.borderType = document.getElementById('borderType').value;
        settings.paperSize = document.getElementById('paperSize').value;
        
        // Add new settings
        settings.colorScheme = document.getElementById('colorScheme').value;
        settings.tagStyle = document.getElementById('tagStyle').value;
        
        // Save to localStorage
        localStorage.setItem('priceTagSettings', JSON.stringify(settings));
        
        // Regenerate price tags with new settings if any exist
        if (selectedProducts.length > 0) {
            generatePriceTags();
        }
        
        // Show notification
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    });
}
  

    // Print price tags
    printButton.addEventListener('click', function() {
        window.print();
    });

    // Switch between tabs
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            switchTab(this);
        });
    });

    function switchTab(tab) {
        // Remove active class from all tabs and contents
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        const tabId = tab.dataset.tab;
        document.getElementById(tabId).classList.add('active');
    }

    // Toggle between layout options
    layoutOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Remove active class from all options
            layoutOptions.forEach(opt => opt.classList.remove('active'));
            
            // Add active class to clicked option
            this.classList.add('active');
            
            // Update settings
            settings.layout = this.dataset.layout;
            
            // Regenerate price tags with new layout
            generatePriceTags();
        });
    });

    // Save settings
    saveSettingsButton.addEventListener('click', function() {
        // Get values from form
        settings.priceTagWidth = parseInt(document.getElementById('priceTagWidth').value) || 60;
        settings.priceTagHeight = parseInt(document.getElementById('priceTagHeight').value) || 40;
        settings.fontSize = parseInt(document.getElementById('fontSize').value) || 18;
        settings.labelsPerPage = parseInt(document.getElementById('labelsPerPage').value) || 12;
        settings.borderType = document.getElementById('borderType').value;
        settings.paperSize = document.getElementById('paperSize').value;
        
        // Save to localStorage
        localStorage.setItem('priceTagSettings', JSON.stringify(settings));
        
        // Regenerate price tags with new settings if any exist
        if (selectedProducts.length > 0) {
            generatePriceTags();
        }
        
        // Show notification
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    });

    // Load products on page load
    loadProducts();

downloadPdfButton.addEventListener('click', async function() {
    // Show loading indicator with improved styling
    loading.style.display = 'flex';
    loading.innerHTML = `
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Sedang menyiapkan PDF...</p>
        </div>
    `;
    
    try {
        const { jsPDF } = window.jspdf;
        
        // Get all price tags
        const priceTags = priceTagsContainer.querySelectorAll('.price-tag');
        
        if (priceTags.length === 0) {
            showNotification('warning', 'Tidak ada label price tag untuk diunduh.');
            loading.style.display = 'none';
            return;
        }
        
        // Create new PDF document with bleed area for cutting
        const doc = new jsPDF({
            orientation: settings.orientation || 'portrait',
            unit: 'mm',
            format: settings.paperSize
        });
        
        // Calculate page dimensions
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        
        // Apply improved margins and spacing between tags
        const margin = settings.margin || 5; // Margin of 5mm
        const horizontalSpacing = settings.horizontalSpacing || 6; // Horizontal spacing between tags
        const verticalSpacing = settings.verticalSpacing || 10; // Vertical spacing of 5mm between tags
        
        // Calculate effective width and height of each tag including spacing
        const effectiveTagWidth = settings.priceTagWidth + horizontalSpacing;
        const effectiveTagHeight = settings.priceTagHeight + verticalSpacing;
        
        // Calculate how many tags fit per row and column with optimized layout
        const tagsPerRow = Math.floor((pageWidth - 2 * margin) / effectiveTagWidth);
        const tagsPerCol = Math.floor((pageHeight - 2 * margin) / effectiveTagHeight);
        const tagsPerPage = tagsPerRow * tagsPerCol;
        
        // Optional: Add compact page header with metadata
        if (settings.showHeader) {
            const today = new Date().toLocaleDateString('id-ID');
            doc.setFontSize(6); // Smaller font size for header
            doc.setTextColor(100, 100, 100);
            doc.text(`Price Tags - Generated: ${today}`, margin, 3); // Positioned higher on page
        }
        
        // Track progress
        let currentPage = 1;
        let tagCounter = 0;
        let processedTags = 0;
        const totalTags = priceTags.length;
        
        // Optional: Add cutting guides with thinner lines
        if (settings.showCuttingGuides) {
            addCuttingGuides(doc, margin, effectiveTagWidth, effectiveTagHeight, tagsPerRow, tagsPerCol);
        }
        
        // Process each price tag with improved layout
        for (let i = 0; i < totalTags; i++) {
            updateLoadingProgress(processedTags, totalTags);
            
            // Calculate position on page with optimized grid layout
            const col = tagCounter % tagsPerRow;
            const row = Math.floor(tagCounter / tagsPerRow) % tagsPerCol;
            
            // Add new page if needed
            if (tagCounter > 0 && tagCounter % tagsPerPage === 0) {
                doc.addPage();
                currentPage++;
                tagCounter = 0;
                
                // Add cutting guides to new page if enabled
                if (settings.showCuttingGuides) {
                    addCuttingGuides(doc, margin, effectiveTagWidth, effectiveTagHeight, tagsPerRow, tagsPerCol);
                }
            }
            
            // Calculate position with margins and spacing - center tags within their cells
            const xPos = margin + (col * effectiveTagWidth) + (horizontalSpacing / 2);
            const yPos = margin + (row * effectiveTagHeight) + (verticalSpacing / 2);
            
            // Capture price tag as canvas with higher quality
            const canvas = await html2canvas(priceTags[i], {
                scale: 4, // Higher resolution for better quality
                backgroundColor: 'white',
                logging: false,
                useCORS: true
            });
            
            // Add to PDF with proper dimensions
            const imgData = canvas.toDataURL('image/png', 1.0);
            doc.addImage(
                imgData, 
                'PNG', 
                xPos, 
                yPos, 
                settings.priceTagWidth, 
                settings.priceTagHeight
            );
            
            // Optional: Add thinner border around each tag if enabled
            if (settings.showBorders) {
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.05); // Thinner lines for borders
                doc.rect(
                    xPos, 
                    yPos, 
                    settings.priceTagWidth, 
                    settings.priceTagHeight
                );
            }
            
            tagCounter++;
            processedTags++;
            
            // Allow UI to update occasionally for better UX with large numbers of tags
            if (i % 10 === 0 && i > 0) {
                await new Promise(resolve => setTimeout(resolve, 0));
            }
        }
        
        // Add compact page numbers if enabled
        if (settings.showPageNumbers && currentPage > 1) {
            addPageNumbers(doc, currentPage);
        }
        
        // Generate filename with date
        const dateStr = new Date().toISOString().slice(0, 10);
        const filename = `price-tags-${dateStr}.pdf`;
        
        // Save the PDF
        doc.save(filename);
        
        showNotification('success', `PDF berhasil dibuat dengan ${totalTags} price tag.`);
    } catch (error) {
        console.error('Error generating PDF:', error);
        showNotification('error', 'Terjadi kesalahan saat membuat PDF. Silakan coba lagi.');
    } finally {
        loading.style.display = 'none';
    }
});

// Helper function to add cutting guides with improved spacing
function addCuttingGuides(doc, margin, tagWidth, tagHeight, tagsPerRow, tagsPerCol) {
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    
    doc.setDrawColor(180, 180, 180); // Lighter color for cutting guides
    doc.setLineDashPattern([0.5, 0.5], 0); // Thinner dash pattern
    doc.setLineWidth(0.05); // Thinner lines
    
    // Draw horizontal cutting guides
    for (let i = 0; i <= tagsPerCol; i++) {
        const y = margin + (i * tagHeight);
        doc.line(margin - 2, y, pageWidth - margin + 2, y); // Shorter extension
    }
    
    // Draw vertical cutting guides
    for (let i = 0; i <= tagsPerRow; i++) {
        const x = margin + (i * tagWidth);
        doc.line(x, margin - 2, x, pageHeight - margin + 2); // Shorter extension
    }
    
    doc.setLineDashPattern([], 0); // Reset dash pattern
}

// Helper function to add compact page numbers
function addPageNumbers(doc, totalPages) {
    const pageWidth = doc.internal.pageSize.getWidth();
    
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(6); // Smaller font for page numbers
        doc.setTextColor(100, 100, 100);
        doc.text(`${i}/${totalPages}`, pageWidth - 10, doc.internal.pageSize.getHeight() - 3); // More compact format
    }
}

// Helper function to update loading progress
function updateLoadingProgress(current, total) {
    const percent = Math.round((current / total) * 100);
    loading.querySelector('p').innerText = `Sedang menyiapkan PDF... ${percent}%`;
}

// Helper function to show notifications
function showNotification(type, message) {
    const notificationElement = document.getElementById('notification') || createNotificationElement();
    notificationElement.className = `notification ${type}`;
    notificationElement.innerText = message;
    notificationElement.style.display = 'block';
    
    setTimeout(() => {
        notificationElement.style.opacity = '1';
    }, 10);
    
    setTimeout(() => {
        notificationElement.style.opacity = '0';
        setTimeout(() => {
            notificationElement.style.display = 'none';
        }, 300);
    }, 3000);
}

// Helper function to create notification element if it doesn't exist
function createNotificationElement() {
    const notification = document.createElement('div');
    notification.id = 'notification';
    notification.className = 'notification';
    document.body.appendChild(notification);
    return notification;
}

// Apply these styles for the new elements
const style = document.createElement('style');
style.textContent = `
    .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 4px;
        color: white;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .notification.success {
        background-color: #28a745;
    }
    
    .notification.warning {
        background-color: #ffc107;
        color: #212529;
    }
    
    .notification.error {
        background-color: #dc3545;
    }
`;
document.head.appendChild(style);

    // Batch label generation function
    

    // Export data function
    function exportSelectedProductsData() {
        if (selectedProducts.length === 0) {
            alert('Pilih minimal satu produk untuk diekspor.');
            return;
        }
        
        // Create CSV content
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Add headers
        csvContent += "Kode Toko,Kode Barang,PLU,Nama Barang,Kategori,Harga Jual,Harga Beli,Stok\n";
        
        // Add data rows
        selectedProducts.forEach(product => {
            const row = [
                product.kodeToko || '',
                product.kode || '',
                product.plu || '',
                product.nama || '',
                product.kategori || '',
                product.hargaJual || 0,
                product.hargaBeli || 0,
                product.stok || 0
            ].join(',');
            
            csvContent += row + "\n";
        });
        
        // Create download link
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "product_data.csv");
        document.body.appendChild(link);
        
        // Trigger download
        link.click();
        
        // Clean up
        document.body.removeChild(link);
    }

    // Add "Batch Print" button to the interface
    const addBatchButtonToInterface = () => {
        const printSection = document.querySelector('.print-section');
        if (printSection) {
            const batchButton = document.createElement('button');
            batchButton.id = 'batchPrintButton';
            batchButton.innerHTML = '<i class="fas fa-copy"></i> Cetak Batch';
            batchButton.addEventListener('click', () => {
                const count = parseInt(prompt('Masukkan jumlah label untuk setiap produk:', '5')) || 0;
                if (count > 0) {
                    generateBatchLabels(count);
                }
            });
            printSection.appendChild(batchButton);
        }
    };

    // Add "Export" button to the interface
    const addExportButtonToInterface = () => {
        const printSection = document.querySelector('.print-section');
        if (printSection) {
            const exportButton = document.createElement('button');
            exportButton.id = 'exportButton';
            exportButton.innerHTML = '<i class="fas fa-file-csv"></i> Export CSV';
            exportButton.addEventListener('click', exportSelectedProductsData);
            printSection.appendChild(exportButton);
        }
    };

    // Call functions to add new buttons
    addBatchButtonToInterface();
    addExportButtonToInterface();

    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+P for print
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            printButton.click();
        }
        
        // Ctrl+S for save settings
        if (e.ctrlKey && e.key === 's' && document.getElementById('settings').classList.contains('active')) {
            e.preventDefault();
            saveSettingsButton.click();
        }
        
        // Ctrl+F for search focus
        if (e.ctrlKey && e.key === 'f' && document.getElementById('browse').classList.contains('active')) {
            e.preventDefault();
            searchInput.focus();
        }

        // Ctrl+B for batch print
        if (e.ctrlKey && e.key === 'b' && document.getElementById('preview').classList.contains('active')) {
            e.preventDefault();
            document.getElementById('batchPrintButton')?.click();
        }

        // Ctrl+E for export
        if (e.ctrlKey && e.key === 'e' && document.getElementById('preview').classList.contains('active')) {
            e.preventDefault();
            document.getElementById('exportButton')?.click();
        }
    });
});
  
  
  
  // Tambahkan tombol diskon ke Print Section
function addDiscountButtonToInterface() {
    const printSection = document.querySelector('.print-section');
    if (printSection) {
        const discountButton = document.createElement('button');
        discountButton.id = 'discountTagsButton';
        discountButton.innerHTML = '<i class="fas fa-percent"></i> Label Diskon';
        discountButton.addEventListener('click', generateDiscountTags);
        
        // Tambahkan sebelum tombol PDF jika ada
        const pdfButton = document.getElementById('downloadPdfButton');
        if (pdfButton) {
            printSection.insertBefore(discountButton, pdfButton);
        } else {
            printSection.appendChild(discountButton);
        }
    }
}

// Fungsi untuk membuat price tag khusus diskon
function generateDiscountTags() {
    // Ambil data diskon dari localStorage
    const diskon = JSON.parse(localStorage.getItem('diskon')) || [];
    const barang = JSON.parse(localStorage.getItem('barang')) || [];
    
    if (diskon.length === 0) {
        Swal.fire({
            title: 'Tidak Ada Diskon',
            text: 'Tidak ada data diskon yang tersedia. Tambahkan diskon terlebih dahulu.',
            icon: 'info',
            confirmButtonColor: '#3b82f6'
        });
        return;
    }
    
    // Filter diskon yang aktif berdasarkan tanggal hari ini
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const activeDiscounts = diskon.filter(item => {
        const startDate = new Date(item.tanggalMulai);
        const endDate = new Date(item.tanggalBerakhir);
        endDate.setHours(23, 59, 59, 999);
        
        return startDate <= today && endDate >= today && item.status === 'active';
    });
    
    if (activeDiscounts.length === 0) {
        Swal.fire({
            title: 'Tidak Ada Diskon Aktif',
            text: 'Tidak ada diskon yang aktif saat ini.',
            icon: 'info',
            confirmButtonColor: '#3b82f6'
        });
        return;
    }
    
    // Tampilkan modal pilih diskon
    showDiscountSelectionModal(activeDiscounts, barang);
}

// Modal untuk memilih diskon yang akan dibuat price tag-nya
function showDiscountSelectionModal(discounts, products) {
    // Siapkan data diskon dengan informasi lengkap produk
    const discountItems = discounts.map(discount => {
        const product = products.find(p => p.kode === discount.kode);
        if (!product) return null;
        
        const hargaDiskon = Math.round(product.hargaJual * (1 - discount.persenDiskon / 100));
        
        return {
            ...discount,
            productName: product.nama,
            originalPrice: product.hargaJual,
            discountedPrice: hargaDiskon,
            saving: product.hargaJual - hargaDiskon,
            product: product
        };
    }).filter(item => item !== null);
    
    if (discountItems.length === 0) {
        Swal.fire({
            title: 'Gagal Memuat Data',
            text: 'Tidak dapat menemukan data produk untuk diskon yang aktif.',
            icon: 'error',
            confirmButtonColor: '#3b82f6'
        });
        return;
    }
    
    // Buat tabel diskon
    let tableRows = '';
    discountItems.forEach((item, index) => {
        tableRows += `
            <tr>
                <td class="checkbox-cell">
                    <input type="checkbox" class="discount-checkbox" data-index="${index}">
                </td>
                <td>${item.product.kode}</td>
                <td>${item.productName}</td>
                <td>${formatRupiah(item.originalPrice)}</td>
                <td>${formatRupiah(item.discountedPrice)}</td>
                <td>${item.persenDiskon}%</td>
                <td>${formatTanggal(item.tanggalBerakhir)}</td>
            </tr>
        `;
    });
    
    Swal.fire({
        title: 'Pilih Diskon untuk Label',
        width: '800px',
        html: `
            <style>
                .discount-selection-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 20px;
                    font-size: 14px;
                }
                .discount-selection-table th, 
                .discount-selection-table td {
                    padding: 8px 12px;
                    text-align: left;
                    border-bottom: 1px solid #e2e8f0;
                }
                .discount-selection-table th {
                    background-color: #f1f5f9;
                    font-weight: 600;
                    color: #334155;
                }
                .discount-selection-table .checkbox-cell {
                    text-align: center;
                    width: 40px;
                }
                .discount-checkbox {
                    cursor: pointer;
                }
                .discount-selection-table tr:hover {
                    background-color: #f8fafc;
                }
                .select-all-container {
                    display: flex;
                    align-items: center;
                    margin-bottom: 12px;
                }
                .select-all-container input {
                    margin-right: 8px;
                }
                .select-all-container label {
                    font-weight: 500;
                    cursor: pointer;
                }
            </style>
            <div class="select-all-container">
                <input type="checkbox" id="selectAllDiscounts">
                <label for="selectAllDiscounts">Pilih Semua</label>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="discount-selection-table">
                    <thead>
                        <tr>
                            <th class="checkbox-cell"></th>
                            <th>Kode</th>
                            <th>Nama Barang</th>
                            <th>Harga Asli</th>
                            <th>Harga Diskon</th>
                            <th>Diskon</th>
                            <th>Berakhir</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            </div>
        `,
        showCancelButton: true,
        confirmButtonColor: '#3b82f6',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Buat Label',
        cancelButtonText: 'Batal',
        didOpen: () => {
            // Inisialisasi "Select All" checkbox
            const selectAllCheckbox = document.getElementById('selectAllDiscounts');
            const checkboxes = document.querySelectorAll('.discount-checkbox');
            
            selectAllCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
            });
            
            // Update "Select All" checkbox state saat perubahan individual checkbox
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
                    
                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate = anyChecked && !allChecked;
                });
            });
        },
        preConfirm: () => {
            const selectedCheckboxes = document.querySelectorAll('.discount-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                Swal.showValidationMessage('Pilih minimal satu diskon untuk dibuat label');
                return false;
            }
            
            // Kumpulkan indeks yang dipilih
            const selectedIndices = Array.from(selectedCheckboxes).map(
                checkbox => parseInt(checkbox.dataset.index)
            );
            
            // Filter item diskon yang dipilih
            const selectedItems = selectedIndices.map(index => discountItems[index]);
            return selectedItems;
        }
    }).then(result => {
        if (result.isConfirmed && result.value) {
            // Siapkan data produk untuk membuat price tags
            const selectedProducts = result.value.map(item => ({
                ...item.product,
                hasDiscount: true,
                discountInfo: {
                    kode: item.kode,
                    persenDiskon: item.persenDiskon,
                    tanggalMulai: item.tanggalMulai,
                    tanggalBerakhir: item.tanggalBerakhir,
                    hargaDiskon: item.discountedPrice
                }
            }));
            
            // Set selected products dan generate price tags
            window.selectedProducts = selectedProducts;
            generatePriceTags();
            
            // Pindah ke tab preview
            switchTab(document.querySelector('.tab[data-tab="preview"]'));
        }
    });
}

// Tambahkan ke dalam kode yang berjalan saat DOM loaded
document.addEventListener('DOMContentLoaded', function() {
    // Tambahkan tombol diskon ke interface
    addDiscountButtonToInterface();
    
    // Tambahkan CSS untuk label diskon yang lebih menarik
    const discountStyles = document.createElement('style');
    discountStyles.textContent = `
        .price-tag-discount-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e63946;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transform: rotate(15deg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 2;
        }
        
        .price-tag-discount-timer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(230, 57, 70, 0.1);
            color: #e63946;
            padding: 3px;
            font-size: 10px;
            text-align: center;
            border-top: 1px dashed rgba(230, 57, 70, 0.3);
        }
        
        .price-tag-discount {
            background: linear-gradient(to bottom right, #fff5f7, white);
            border: 2px solid #fecdd3 !important;
            position: relative;
            overflow: hidden;
        }
        
        .price-tag-discount::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(135deg, rgba(230, 57, 70, 0.1) 0%, rgba(230, 57, 70, 0) 60%);
            z-index: 0;
        }
        
        .price-tag-discount > * {
            position: relative;
            z-index: 1;
        }
    `;
    document.head.appendChild(discountStyles);
});

// Helper untuk format tanggal
function formatTanggal(tanggal) {
    if (!tanggal) return '-';
    const options = { day: 'numeric', month: 'short', year: 'numeric' };
    return new Date(tanggal).toLocaleDateString('id-ID', options);
}

// Helper untuk format rupiah (mengambil dari kode yang sudah ada)
function formatRupiah(amount) {
    if (!amount) return 'Rp 0';
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

// Buat tampilan price tag diskon yang lebih mencolok
const originalGeneratePriceTags = window.generatePriceTags;
window.generatePriceTags = function() {
    // Panggil fungsi original
    originalGeneratePriceTags();
    
    // Tambahkan elemen khusus pada price tag dengan diskon
    const priceTags = document.querySelectorAll('.price-tag');
    priceTags.forEach((tag, index) => {
        if (index < selectedProducts.length && selectedProducts[index].hasDiscount) {
            // Tambahkan kelas khusus untuk price tag diskon
            tag.classList.add('price-tag-discount');
            
            // Tambahkan badge persentase diskon
            const discountBadge = document.createElement('div');
            discountBadge.className = 'price-tag-discount-badge';
            discountBadge.textContent = `-${selectedProducts[index].discountInfo.persenDiskon}%`;
            tag.appendChild(discountBadge);
            
            // Tambahkan timer diskon
            const discountTimer = document.createElement('div');
            discountTimer.className = 'price-tag-discount-timer';
            
            const endDate = new Date(selectedProducts[index].discountInfo.tanggalBerakhir);
            const options = { day: 'numeric', month: 'short' };
            const formattedDate = endDate.toLocaleDateString('id-ID', options);
            
            discountTimer.textContent = `Berakhir: ${formattedDate}`;
            tag.appendChild(discountTimer);
        }
    });
};
  
  
  
    </script>
</body>
</html>
